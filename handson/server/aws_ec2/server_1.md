# サーバを作ろう！

本ページでは、AWS EC2 でインスタンスを立てて、nginxをインストールするところまでの手順を記載します。

公式のドキュメントがあるので、それを参考に作成しています。
<a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/create-linux-instance/" target="_blank">Amazon Linux インスタンスを作成する - AWS</a>
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank">Amazon EC2 Linux インスタンス入門</a>


# 構築の流れ
- AWSコンソールにログインする
- EC2 インスタンスを作成する
- セキュリティグループを変更してHTTPでアクセスできるようにする
- SSHアクセスできるようにする
- nginxをインストールする

# AWSコンソールにログインする
AWSアカウントを作成してコンソールにログインする

公式の手順が一番わかりやすいので、そちらを参照
<a href="https://aws.amazon.com/jp/register-flow/" target="_blank">AWS アカウント作成の流れ</a>



# リージョンを選択する

EC2インタンスを作成する前に、どこのリージョンにインタンスを作るのかを決めます。

リージョンは国単位に分かれており、これを選ぶことは「自分のAWSのデータを、どこの国のデータセンターに作成するのか」を選ぶことに相当します。

<a href="https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" target="_blank">リージョンとゾーン - Amazon Elastic Compute Cloud</a>


リージョンを選ぶ場合、「料金」と「利用できるサービス」と「通信速度」が選考のポイントになると思います。

料金と通信速度はAWSサービス毎に異なります。


使用したいAWSサービスを決めた上で、「料金」「利用できるサービス」「通信速度」の観点から最適なリージョンを選択しましょう。

参考　<a href="https://cloud-textbook.com/734/"  target="_blank">AWS のリージョンの選び方</a>

### リージョン選択方法

今回はテストで作成するので「料金」「利用できるサービス」「通信速度」はあまり気にする必要はありません

日本のデータセンターであるほうが通信速度が出るであろう、という理由でコンソール左上のプルダウンから「東京」リージョンを選択します。

![region_01](..\img\region_01.png)


# EC2 インスタンスを作成する

## EC2画面に移動

コンソールの上にある検索欄に「EC2」と入れて検索し、表示されたらそれを選択します。
![ec2_01](../img/ec2_01.png)







## インスタンス作成画面に移動

E2Cのダッシュボードに移動するので、「インスタンスを起動」を選択します。
![ec2_02.png](../img/ec2_02.png)



## OSを選択

作成するインスタンスのOSを選択します。
今回はAmazon Linux2を選びます。無料なので

![ec2_03.png](../img/ec2_03.png)



OSを選ぶ時に64ビット(x86)と64ビット(Arm)を選べます
これによって後に選択できるインスタンス タイプが変わります。

無料枠で利用する場合はx86を選びます。



## インスタンスタイプを選択

インスタンスタイプはCPU性能とかメモリ容量とかディスク容量だとかのスペックの組み合わせにt2.microとかの名前を付けたものです。
<a href="https://aws.amazon.com/jp/ec2/instance-types/" target="_blank">Amazon EC2 インスタンスタイプ</a>

今回はt2.microを選びます。無料なので

「確認と作成」を選択して確認画面に遷移します。

![ec2_04.png](../img/ec2_04.png)



なお、「次のステップ：インスタンスの詳細の設定」を選択するとスペックの詳細設定が可能です。
デフォルトだとディスク容量が8Gなのですが、これを30Gまで増やせるので、そこだけ設定しても良いかもしれません



## 確認してインスタンスを作成

作成する内容を確認して「起動」を選択します。

デフォルト設定だとセキュリティグループの警告が表示されますが、後で設定するので一旦無視します。

![ec2_05.png](../img/ec2_05.png)



## キーペアの作成

キーペアは作成したインスタンスにSSH接続する際の鍵ファイルになります。

・「新しいキーペアを作成」を選択
・キーペアのタイプはRSA
・キーペア名は適当
にしてキーペアをダウンロードします。

ダウンロードしたら「インスタンスの作成」を選択します。
これでインスタンスの作成はできました。

![ec2_06.png](../img/ec2_06.png)





# セキュリティグループを変更してHTTPでインスタンスにアクセスできるようにする

セキュリティグループは、ファイアウォールのようなもので
特定の通信を許可したり禁止したりする設定のグループです。

デフォルトではSSH以外の通信はNGになっているようなので
HTTPの通信を許可してやる必要があります。

まずはセキュリティグループの編集画面に移動します。

左メニューの「セキュリティグループ」
↓
インスタンス作成時に作ったセキュリティグループ名を選択（launch-wizard-1）
↓
「Edit inbound rules」を選択

![ec2_07.png](../img/ec2_07.png)



初期状態ではSSHの設定のみ存在します。
HTTPの設定を追加しましょう

・「ルールを追加」を押す
・追加された項目のタイプをHTTPに変更する
・追加された項目のソースをAnywhere-IPv4に変更する
・「ルールを保存」を押す

![ec2_08.png](../img/ec2_08.png)



この時、ソースのところに「0.0.0.0/0」と表記されています。
これは「全てのIPアドレス」示す値なので、
このセキュリティグループは「SSHとHTTPの接続であれば、どのIPアドレスからでも受けれますよ」という設定になります。

特にSSHを全てのIPアドレスからアクセス許可してしまうのは危険なので、なるべく自分のIPからしかアクセスを受け付けないよう制御をかけましょう

自身のIPアドレスを調べるのはwebサービスを使うのが簡単です
https://www.cman.jp/network/support/go_access.cgi

IPアドレスが分かったら、ソースを「カスタム」にして、調べたアドレスを入力しましょう。

もしくは、ソースに「マイIP」を選択すれば、自動で自分のIPを設定してくれます。

# SSHでアクセスする

作成したインスタンスにSSHでアクセスします。
自分のSSHクライアントで以下を実行します。

```
$ ssh -i "キーペア.pem" ec2-user@"インスタンスのIPアドレス"
```

・キーペア.pemはインスタンス作成時にダウンロードしたキーペアを指定してください
・ユーザ名はデフォルトのec2-userになります。
・インスタンスのIPアドレスは作成したインスタンスの詳細ページにある「パブリックIP4アドレス」がそれに当たります。


もしアクセスできない場合はセキュリティグループでSSHと自身のIPアドレスが許可されているか確認してみてください





# nginxをインストールする

SSH接続できたらnginxをインストールします。

amazon-linux-extrasというコマンドはAmazon Linux2用のyumコマンドのようなもので
Amazon Linux2がサポートしている最新verの各種パッケージがインストールできるようです。

■Amazon Linux Extras
https://aws.amazon.com/amazon-linux-2/faqs/#Amazon_Linux_Extras


```
sudo amazon-linux-extras install nginx1
```

インストールできたらnginxを起動します。

```
$ sudo systemctl start nginx

# 起動できたか確認
$ systemctl status nginx
```

これで設定は終わりです。
ブラウザからhttpで以下URLにアクセスしてみましょう
無事に作成したインスタンスにアクセスできれば、以下画面が表示されます。
<a>http://{インスタンスにsshする時に指定したIPアドレス}</a>
例　http://3.113.110.154/



![ec2_09.png](../img/ec2_09.png)

もし、表示されなければセキュリティグループの設定を見直して
・HTTPが許可されていること
・自分のIPアドレスが許可されていること
を確認してみてください